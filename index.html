<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Danh sÃ¡ch tÃ i xáº¿ Ä‘ang ráº£nh gáº§n báº¡n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .driver { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
    .status { font-weight: bold; margin-left: 10px; color: green; }
    button { padding: 6px 12px; font-size: 14px; margin-top: 6px; }
    .help { background: #fffbe6; border: 1px solid #ffd700; padding: 15px; border-radius: 8px; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>ğŸ“‹ TÃ i xáº¿ Ä‘ang ráº£nh gáº§n báº¡n nháº¥t</h2>
  <div id="list">â³ Äang xÃ¡c Ä‘á»‹nh vá»‹ trÃ­...</div>

  <script>
    const drivers = [
      { name: 'TÃ i xáº¿ A', vehicle: 'Xe mÃ¡y', location: [106.7009, 10.7769], status: 'available' },
      { name: 'TÃ i xáº¿ B', vehicle: 'Ã” tÃ´ 4 chá»—', location: [106.6829, 10.7629], status: 'busy' },
      { name: 'TÃ i xáº¿ C', vehicle: 'Ã” tÃ´ 7 chá»—', location: [106.7100, 10.7800], status: 'moving' },
      { name: 'TÃ i xáº¿ D', vehicle: 'TrÃªn 7 chá»—', location: [106.6955, 10.7705], status: 'available' }
    ];

    const vehicleSpeeds = {
      'Xe mÃ¡y': 45,
      'Ã” tÃ´ 4 chá»—': 60,
      'Ã” tÃ´ 7 chá»—': 55,
      'TrÃªn 7 chá»—': 50
    };

    navigator.geolocation.getCurrentPosition(
      function(position) {
        const userLocation = [position.coords.longitude, position.coords.latitude];
        const availableDrivers = drivers.filter(d => d.status === 'available');

        const promises = availableDrivers.map(driver => {
          const url = `https://router.project-osrm.org/route/v1/driving/${driver.location.join(',')};${userLocation.join(',')}?overview=false`;
          return fetch(url)
            .then(res => res.json())
            .then(data => {
              const distanceKm = data.routes[0].distance / 1000;
              const speed = vehicleSpeeds[driver.vehicle] || 50;
              const durationMin = Math.round((distanceKm / speed) * 60);
              const hours = Math.floor(durationMin / 60);
              const minutes = durationMin % 60;
              const timeLabel = hours > 0 ? `${hours} giá» ${minutes} phÃºt` : `${minutes} phÃºt`;
              return { ...driver, distanceKm, timeLabel };
            });
        });

        Promise.all(promises).then(results => {
          const sorted = results.sort((a, b) => a.distanceKm - b.distanceKm);
          const container = document.getElementById('list');
          container.innerHTML = '';

          sorted.forEach(driver => {
            const div = document.createElement('div');
            div.className = 'driver';
            div.innerHTML = `
              ${driver.name} xe "${driver.vehicle}" â€“ ğŸ“ ${driver.distanceKm.toFixed(2)} km â€“ â±ï¸ ${driver.timeLabel}
              <span class="status">(Äang ráº£nh)</span><br>
              <button onclick="openMap(${driver.location[1]}, ${driver.location[0]}, ${userLocation[1]}, ${userLocation[0]})">ğŸ” Kiá»ƒm tra</button>
            `;
            container.appendChild(div);
          });

          if (sorted.length === 0) {
            container.innerHTML = 'âŒ KhÃ´ng cÃ³ tÃ i xáº¿ Ä‘ang ráº£nh gáº§n báº¡n.';
          }
        });
      },
      function(error) {
        if (error.code === error.PERMISSION_DENIED) {
          showLocationHelp();
        } else {
          document.getElementById('list').innerHTML = 'âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c vá»‹ trÃ­. Vui lÃ²ng thá»­ láº¡i.';
        }
      },
      { enableHighAccuracy: true }
    );

    function openMap(driverLat, driverLng, userLat, userLng) {
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      const url = isIOS
        ? `http://maps.apple.com/?saddr=${driverLat},${driverLng}&daddr=${userLat},${userLng}`
        : `https://www.google.com/maps/dir/?api=1&origin=${driverLat},${driverLng}&destination=${userLat},${userLng}`;
      window.open(url, '_blank');
    }

    function showLocationHelp() {
      const help = document.createElement('div');
      help.className = 'help';
      help.innerHTML = `
        <h3>âš ï¸ Báº¡n Ä‘Ã£ tá»« chá»‘i quyá»n Ä‘á»‹nh vá»‹</h3>
        <p>Äá»ƒ sá»­ dá»¥ng Ä‘áº§y Ä‘á»§ chá»©c nÄƒng, vui lÃ²ng má»Ÿ láº¡i quyá»n Ä‘á»‹nh vá»‹:</p>
        <ul>
          <li><b>TrÃªn iPhone/iPad (Safari):</b> Nháº¥n vÃ o biá»ƒu tÆ°á»£ng <b>aA</b> á»Ÿ gÃ³c trÃ¡i thanh Ä‘á»‹a chá»‰ â†’ <b>CÃ i Ä‘áº·t trang web</b> â†’ <b>Vá»‹ trÃ­</b> â†’ chá»n <b>Cho phÃ©p</b></li>
          <li><b>TrÃªn Android (Chrome):</b> Nháº¥n vÃ o biá»ƒu tÆ°á»£ng <b>ğŸ”’ á»• khÃ³a</b> bÃªn cáº¡nh URL â†’ <b>Quyá»n</b> â†’ <b>Vá»‹ trÃ­</b> â†’ chá»n <b>Cho phÃ©p</b></li>
          <li><b>TrÃªn mÃ¡y tÃ­nh:</b> Nháº¥n vÃ o biá»ƒu tÆ°á»£ng <b>ğŸ”’ á»• khÃ³a</b> bÃªn cáº¡nh URL â†’ chá»n <b>Vá»‹ trÃ­</b> â†’ chuyá»ƒn sang <b>Cho phÃ©p</b> rá»“i táº£i láº¡i trang</li>
        </ul>
        <p><b>ğŸ“Œ Sau khi cáº¥p láº¡i quyá»n, hÃ£y táº£i láº¡i trang Ä‘á»ƒ tiáº¿p tá»¥c.</b></p>
        <button onclick="location.reload()">ğŸ”„ Táº£i láº¡i trang</button>
      `;
      document.getElementById('list').innerHTML = '';
      document.body.appendChild(help);
    }
  </script>
</body>
</html>
